<html>

<head>
<style type="text/css">
	.chart text { fill: black; text-anchor: middle; }
	.chart line { stroke-width: 1; stroke: lightgray; }
	.chart circle {stroke: white; cursor: pointer;}
	.chart circle:hover {stroke: black;}
	.chart rect {cursor: pointer;fill:lightblue;stroke:black;}
	#tooltip {
	    opacity: 0;
	    position: absolute;
	    text-align: left;
	    /*width: 60px; height: 40px;*/
	    background: white;
	    stroke: black;
	    border: 5px solid black;
	}
	
</style>
</head>

<body onload='init()'>
		<h2> Choose one or more region </h2>
		<div class="multiselect">
			<input type="checkbox" id="Latin America & Caribbean" checked> Latin America & Caribbean
			<input type="checkbox" id="South Asia" checked>South Asia
			<input type="checkbox" id="Sub-Saharan Africa" checked>Sub-Saharan Africa
			<input type="checkbox" id="Europe & Central Asia" checked>Europe & Central Asia
			<input type="checkbox" id="Middle East & North Africa" checked>Middle East & North Africa
			<input type="checkbox" id="East Asia & Pacific" checked>East Asia & Pacific
			<input type="checkbox" id="North America" checked>North America
		</div>
		<svg class="chart" width=1200 height=610></svg>
		<div class="status">Click on an year</div>
		<div id="tooltip"></div>

<script src='https://d3js.org/d3.v5.min.js'></script>
<script>
function getFilteredData(data, year, region){
		var filteredData = data.filter(function (el) {
			return el.year == year && region.includes(el.Region); 
		});
		return filteredData;
}

async function init() {
	const data = await d3.csv("https://raw.githubusercontent.com/kautukkhare/narrativeViz/master/GDPAndHomicideData.csv");

	//var obj = {"Country Code":"ABW","Short Name":"Aruba","Region":"Latin America & Caribbean","year":"1995","GDPPerCapita":"26,705","GDPperCapitaPPP":"39,113","Homicide":"","HomicideFemale":"","Population":"80,324"};
	
	//get the years as an array
	const years = [...new Set(data.map(eachData => eachData.year))]
	const regions = [...new Set(data.map(eachData => eachData.Region))]

	var selectedYear = years[0];

	function getRegionsList() {
		var checkBoxList = document.getElementsByTagName("input");;
		var regionList = [];
		var i;
		for (i = 0; i < checkBoxList.length; i++) {
  			if (checkBoxList[i].checked) {
    			regionList.push(checkBoxList[i].id);
  			}
		}
		return regionList;
	}

	var regionList = getRegionsList();
	console.log(regionList);

	//Define Scales
	var xlogScale = d3.scaleLinear()
	.domain([150, 200000])
	.range([0, 1100]);

	var ylogScale = d3.scaleLinear()
	.domain([0, 150])
	.range([500, 0]);


    var rScale = d3.scaleLinear()
    .domain([9230,1386395000])
    .range([10,70]);

    var colorScale = d3.scaleOrdinal()
          .domain(regions)
          .range(d3.schemeSet2);

	var rectWidth = 50;
	var rectHeight = 25;

	//Add scatterplot element
	scatterPlot = d3.select('svg')
	.append("g")
	.attr("id","plot")
	.attr("transform", "translate(50,50)");


	//Add Axes
	d3.select("svg")
	.append("g")
	.attr("transform", "translate(50,50)")
	.call(d3.axisLeft(ylogScale));

	d3.select("svg")
	.append("g")
	.attr("transform", "translate(50,550)")
	.call(d3.axisBottom(xlogScale));


	//Add Years control

	var yearsBarSVG = d3.select("svg")
	.append("g")
	.attr("transform", "translate(50,575)");

	yearsBarSVG.selectAll('rect')
	.data(years)
	.enter()
	.append('rect')
	.attr('x',function(d,i) {return i*rectWidth;})
	.attr('y',0)
	.attr('width', rectWidth)
	.attr('height',rectHeight)
	//.attr('class', "yearsBar")
	.on('click', function(d, i) {
		selectedYear = d;
		d3.select('.status')
		.text('You clicked on year ' + d);
		plotGraph(scatterPlot,getFilteredData(data,d, getRegionsList()));
	  });
	
	yearsBarSVG.selectAll('text')
	.data(years)
	.enter()
	.append('text')
	.attr('x',function(d,i) {return i*rectWidth;})
	.attr('y',0)
	.attr("dx", function(d){return 23})
	.attr("dy", function(d){return 17})
	.attr('style',"cursor: pointer")
	.text(function(d){return d})
	.on('click', function(d, i) {
		selectedYear = d;
		d3.select('.status')
		.text('You clicked on year ' + d);
		plotGraph(scatterPlot,getFilteredData(data,d, getRegionsList()));
	  });

	// Adding Tooltip functions
	var tooltip = d3.select("#tooltip");

	//Define plotting function
	function plotGraph(element, d){
		element.selectAll('circle').remove();
		element.selectAll('circle')
			.data(d)
			.enter()
			.append('circle')
			.attr("cx", function(d,i) {return xlogScale(parseFloat(d.GDPPerCapita.replace(/,/g, '')));})
			.attr("cy", function(d,i) {return ylogScale(d.Homicide);})
			.attr("r", function(d,i) {return rScale(parseFloat(d.Population.replace(/,/g, '')));})
			.style("fill", function(d){ return colorScale(d.Region); })
			.on("mouseover", function(d,i) {
        		tooltip.style("opacity", 1)
               .style("left",(d3.event.pageX)+"px")
               .style("top",(d3.event.pageY)+"px")
               .html("Country: " + d["Short Name"] 
	      		+ "<br />" + "GDP Per Capita: " + d.GDPPerCapita
	      		+ "<br />" + "Homicide Rate (per 100,000 people): " + d.Homicide
	      		+ "<br />" + "Population: " + d.Population);
    			})
    		.on("mouseout", function() { tooltip.style("opacity", 0) });
	}
	//parseFloat(d.GDPPerCapita.replace(/,/g, ''));

	//plot data for first year
	var filteredData = getFilteredData(data,selectedYear,getRegionsList());
	plotGraph(scatterPlot,filteredData);

	d3.selectAll("input")
  		.on('change', function(i) {
  			console.log(getRegionsList());
    		plotGraph(scatterPlot,getFilteredData(data,selectedYear, getRegionsList()));
		});
	

}
</script>
</body>
</html>