<html>

<head>
<style type="text/css">
	text { fill: black; text-anchor: middle; }
	line { stroke-width: 1; stroke: lightgray; }
	circle {stroke: black;}
	rect {cursor: pointer;fill:lightblue;stroke:black;}
</style>
</head>

<body onload='init()'>
	<svg width=1200 height=610></svg>
	<div class="status">Click on an year</div>


<script src='https://d3js.org/d3.v5.min.js'></script>
<script>
function getFilteredData(data, year){
		var filteredData = data.filter(function (el) {
			return el.year == year; 
		});
		return filteredData;
}

async function init() {
	const data = await d3.csv("https://raw.githubusercontent.com/kautukkhare/narrativeViz/master/GDPAndHomicideData.csv");

	//var obj = {"Country Code":"ABW","Short Name":"Aruba","Region":"Latin America & Caribbean","year":"1995","GDPPerCapita":"26,705","GDPperCapitaPPP":"39,113","Homicide":"","HomicideFemale":"","Population":"80,324"};
	var obj = data[0];
	
	var jsonObj = JSON.parse(JSON.stringify(obj));
	console.log(obj);
	console.log(jsonObj);
	console.log(obj.year);
	console.log(jsonObj["Short Name"]);
	console.log(jsonObj["Region"]);
	console.log(jsonObj["year"]);
	
	//get the years as an array
	const years = [...new Set(data.map(eachData => eachData.year))]
	const regions = [...new Set(data.map(eachData => eachData.Region))]

	console.log(years);
	

	//Define Scales
	var xlogScale = d3.scaleLinear()
	.domain([150, 200000])
	.range([0, 1100]);

	var ylogScale = d3.scaleLinear()
	.domain([0, 150])
	.range([500, 0]);

	var rScale = d3.scaleLog()
    .base(Math.E)
    .domain([9230,1386395000])
    .range([0.01,50]);

    var colorScale = d3.scaleOrdinal()
          .range(["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2"])
          .domain(regions);

	var rectWidth = 50;
	var rectHeight = 25;

	//Add scatterplot element
	scatterPlot = d3.select('svg')
	.append("g")
	.attr("id","plot")
	.attr("transform", "translate(50,50)");


	//Add Axes
	d3.select("svg")
	.append("g")
	.attr("transform", "translate(50,50)")
	.call(d3.axisLeft(ylogScale));

	d3.select("svg")
	.append("g")
	.attr("transform", "translate(50,550)")
	.call(d3.axisBottom(xlogScale));


	//Add Years control

	var yearsBarSVG = d3.select("svg")
	.append("g")
	.attr("transform", "translate(50,575)");

	yearsBarSVG.selectAll('rect')
	.data(years)
	.enter()
	.append('rect')
	.attr('x',function(d,i) {return i*rectWidth;})
	.attr('y',0)
	.attr('width', rectWidth)
	.attr('height',rectHeight)
	//.attr('class', "yearsBar")
	.on('click', function(d, i) {
		d3.select('.status')
		.text('You clicked on year ' + d);
		plotGraph(scatterPlot,getFilteredData(data,d));
	  });
	
	yearsBarSVG.selectAll('text')
	.data(years)
	.enter()
	.append('text')
	.attr('x',function(d,i) {return i*rectWidth;})
	.attr('y',0)
	.attr("dx", function(d){return 23})
	.attr("dy", function(d){return 17})
	.attr('style',"cursor: pointer")
	.text(function(d){return d})
	.on('click', function(d, i) {
		d3.select('.status')
		.text('You clicked on year ' + d);
		plotGraph(scatterPlot,getFilteredData(data,d));
	  });;


	

	//Define plotting function
	function plotGraph(element, d){
		element.selectAll('circle').remove();
		element.selectAll('circle')
			.data(d)
			.enter()
			.append('circle')
			.attr("cx", function(d,i) {return xlogScale(parseFloat(d.GDPPerCapita.replace(/,/g, '')));})
			.attr("cy", function(d,i) {return ylogScale(d.Homicide);})
			.attr("r", function(d,i) {return rScale(parseFloat(d.Population.replace(/,/g, '')));})
			.style("fill", function(d){ return colorScale(d.Region); });
	}
	//parseFloat(d.GDPPerCapita.replace(/,/g, ''));

	//plot data for first year
	var filteredData = getFilteredData(data,years[0]);
	plotGraph(scatterPlot,filteredData);


}
</script>
</body>
</html>